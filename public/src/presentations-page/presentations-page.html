<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../bower_components/app-route/app-route.html">
<link rel="import" href="../../bower_components/paper-spinner/paper-spinner.html">

<link rel="import" href="../signup-page/presentation-row.html">
<!--
A comment describing this element

Example:

    <my-elem></my-elem>

Example:

    <my-elem>
      <h2>Hello my-elem</h2>
    </my-elem>

@demo demo/index.html
-->

<dom-module id="presentations-page">
  <template>
    <style>
      :host {
        display: block;
      }
      paper-material {
        background-color: white;
        padding: 8px;
        margin-bottom: 16px;
      }
      h3 {
        margin: 0px;
      }
      presentation-row:hover {
        background-color: #e6e6e6;
      }
      div.page-load {

      }
      .page-load {
        position: fixed;
        left: 50vw;
        top: 50vh;
        z-index: 5000;
      }
    </style>
    <app-route route="{{route}}" pattern="/presentations" active="{{active}}"></app-route>
    <iron-ajax
      id="datesAjax"
      url="[[_computeAPI('/dates')]]"
      handle-as="json"
      on-error="_onError"
      last-response="{{dates}}"></iron-ajax>
    <iron-ajax
      id="blocksAjax"
      url="[[_computeAPI('/blocks')]]"
      handle-as="json"
      on-error="_onError"
      last-response="{{blocks}}"></iron-ajax>
    <iron-ajax
      id="presentationsAjax"
      url="[[_computeAPI('/presentations')]]"
      handle-as="json"
      on-response="_presentationsLoaded"
      on-error="_onError"
      last-response="{{presentations}}"></iron-ajax>
    <iron-ajax
      id="gradesAjax"
      url="[[_computeAPI('/grades')]]"
      handle-as="json"
      on-error="_onError"
      last-response="{{grades}}"></iron-ajax>

    <paper-spinner id="spinner" active class="page-load"></paper-spinner>

    <template is="dom-repeat" items="[[dates]]" as="date">
      <template is="dom-repeat" items="[[_objToArray(blocks)]]" as="block">
        <paper-material elevation="1">
        <h3>[[_parseDate(date.date)]] - [[block.block_name]]</h3>

        <template is="dom-repeat" items="[[_filterPresentations(date.date, block.block_id, presentations)]]" as="presentation">
          <presentation-row
            data="[[presentation]]"
            data-id$="[[presentation.presentation_id]]"
            on-show-info="_showInfo"
            grades="[[gradesArray]]"
            viewer-count
            viewer-count-data="[[countData]]"
            ></presentation-row>
        </template>

      </paper-material>
      </template>
      
    </template>
  </template>
  <script>
    Polymer({
      is: 'presentations-page',
      properties: {
        route: {
          type: Object
        },
        active: {
          type: Boolean,
          observer: '_activeChanged'
        },
        gradesArray: {
          type: Array,
          computed: '_objToArray(grades)'
        },
        countData: {
          type: Object,
          value: {
            grades: [
              { grade_name: '9th', count: 0 },
              { grade_name: '10th', count: 0 },
              { grade_name: '11th', count: 0 },
              { grade_name: '12th', count: 0 }
            ],
            total_count: 0,
            total_limit: 37
          }
        }
      },
      observers: [
        '_dataLoaded(dates, blocks, presentations, grades)'
      ],
      _computeAPI: function (path) {
        var apiRootPath = 'https://4n5e3ppiq7.execute-api.us-east-2.amazonaws.com/v1';
        return apiRootPath + path;
      },
      _onError: function(e) {
        console.log(e);
      },
      _objToArray: function(obj) {
        if(obj)
          return Object.keys(obj).map(function (key) { return obj[key]; });
      },
      _activeChanged: function(e) {
        if(e) {
          this.$.datesAjax.generateRequest();
          this.$.blocksAjax.generateRequest();
          this.$.presentationsAjax.generateRequest();
          this.$.gradesAjax.generateRequest();
        }
      },
      _parseDate: function(e) {
        var str = e.toString();
        console.log(str);

        if(!/^(\d){8}$/.test(str))
          return "Invalid date!";

        var y = str.substr(0,4),
            m = str.substr(4,2),
            d = str.substr(6,2);
            console.log(y + " " + m + " " + d);
        return new Date(y,parseInt(m) - 1,d).toDateString();
      },
      _filterPresentations: function(date, block, presentations) {
        var result = [];

        for(var k in presentations) {
          if(!presentations.hasOwnProperty(k)) continue;
          
          var thisPresentation = presentations[k];

          if(thisPresentation.date === date && thisPresentation.block_id === block)
            result.push(thisPresentation);
        }

        return result;
      },
      _dataLoaded: function(dates, blocks, presentations, grades) {
        if(dates && blocks && presentations, grades) {
          this.$.spinner.hidden = true;
          this.$.spinner.active = false;
        }
      }
    });
  </script>
</dom-module>
<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../bower_components/paper-styles/color.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/paper-radio-group/paper-radio-group.html">
<link rel="import" href="../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../stable-app/stable-behavior.html">

<!--
A comment describing this element

Example:

    <my-elem></my-elem>

Example:

    <my-elem>
      <h2>Hello my-elem</h2>
    </my-elem>

@demo demo/index.html
-->

<dom-module id="signup-form">
  <template>
    <style include="iron-flex iron-flex-alignment">
      :host {
        display: block;
        background-color: white;
        max-width: 320px;
      }
      paper-input {
        margin: 0;
        
      }
      paper-material {
        padding: 16px;
      }
      paper-button[disabled] {
        background-color: var(--paper-grey-500);
        color: white;
      }
      h4 {
        margin: 0;
        margin-left: auto;
        margin-right: auto;
      }
      .start {
        background-color: var(--paper-blue-500);
        color: white;
      }
      .reset {
        background-color: var(--paper-red-500);
        color: white;
      }
      h2 {
        margin: 0;
      }
      p {
        margin-top: 0;
      }
      h3 {
        margin: 0;
        margin-bottom: 4px;
      }
      #placeholder {
        width: 288px;
        height: 305px;
      }
      .center {
        margin-left: auto;
        margin-right: auto;
      }
      .grades {
        --paper-radio-group-item-padding: 12px 8px;
      }
      .houses {
        --paper-radio-group-item-padding: 12px 4px;
      }
      paper-toast {
        z-index: 10001;
      }
    </style>
    <iron-ajax
      id="signupAjax"
      url="[[_computeAPI('/signup')]]"
      method="POST"
      content-type="application/json"
      handle-as="json"
      on-request="_request"
      on-response="_response"
      on-error="_error"></iron-ajax>
    <paper-material elevation="1">
      <div class="layout vertical" id="mainForm" hidden$="[[!_dataReady]]">
        <!-- <h4>Signup!</h4> -->
        <paper-input label="First Name" value="{{firstname::input}}"></paper-input>
        <paper-input label="Last Name" value="{{lastname::input}}"></paper-input>
        <h4>Grade</h4>
        <paper-radio-group attr-for-selected="data-id" selected="{{grade}}" class="grades">
          <template is="dom-repeat" items="[[_objToArray(grades)]]">
            <paper-radio-button data-id$="[[item.grade_id]]">[[item.grade_name]]</paper-radio-button>
          </template>
        </paper-radio-group>
        <h4>House</h4>
        <paper-radio-group attr-for-selected="data-id" selected="{{house}}" class="houses">
          <template is="dom-repeat" items="[[_objToArray(houses)]]">
            <paper-radio-button data-id$="[[item.house_id]]">[[item.house_name]]</paper-radio-button>
          </template>
        </paper-radio-group>
        <h4 hidden$="[[!isSenior]]">My Presentation</h4>
        <div class="center" hidden$="[[!isSenior]]">[[_seniorInfo(senior, presentations)]]</div>
        <div class="layout horizontal" style="margin-top: 16px;">
          <div class="flex"></div>
          <paper-button id="submit" class="start" raised on-tap="_confirm">Start!</paper-button>
          <paper-button id="reset" class="reset" raised on-tap="_reset">Reset</paper-button>
        </div>
      </div>
      <div class="layout vertical" id="placeholder" hidden$="[[_dataReady]]">
        <div class="flex"></div>
          <div class="layout horizontal">
            <div class="flex"></div>
            <h3>Fetching Data...</h3>
            <div class="flex"></div>
          </div>
          <div class="layout horizontal">
            <div class="flex"></div>
            <paper-spinner active></paper-spinner>
            <div class="flex"></div>
          </div>
        <div class="flex"></div>
      </div>
      
    </paper-material>
    <paper-dialog id="confirmDialog">
      <div class="layout vertical">
        <h2>Confirm</h2>
        <p>Are you sure this information is correct?</p>
        <div>First Name: <b>[[firstname]]</b></div>
        <div>Last Name: <b>[[lastname]]</b></div>
        <div>Grade: <b>[[_getAttrFromObj(grade, 'grade_name', grades)]]</b></div>
        <div>House: <b>[[_getAttrFromObj(house, 'house_name', houses)]]</b></div>
        <div class="layout horizontal" style="margin-top: 16px;">
          <div class="flex"></div>
          <paper-button id="confirmButton" raised class="start" on-tap="_submit">
            <paper-spinner id="spinner" active hidden></paper-spinner>
            <div id="confirmText">Confirm</div>
          </paper-button>
          <paper-button id="cancelButton" raised on-tap="_cancel" class="reset">Cancel</paper-button>
        </div>
      </div>
      
    </paper-dialog>
  </template>
  <script>
    Polymer({
      is: 'signup-form',
      properties: {
        grades: {
          type: Object
        },
        houses: {
          type: Object
        },
        firstname: {
          type: String,
          value: ''
        },
        lastname: {
          type: String,
          value: ''
        },
        grade: {
          type: String,
          value: '-1',
          observer: '_grade'
        },
        house: {
          type: String,
          value: '-1'
        },
        _ajaxRequest: {
          type: Object,
          value: null
        },
        _dataReady: {
          type: Boolean,
          value: false,
          computed: '_computeDataReady(presentations, houses, grades)'
        },
        presentations: {
          type: Object
        },
        isSenior: {
          type: Boolean,
          computed: '_isSenior(grade)'
        },
        senior: {
          type: Number
        }
      },
      observers: [
        '_inputChanged(firstname, lastname, grade, house)'
      ],
      behaviors: [
        StableBehavior
      ],
      _seniorInfo: function(id, p) {
        if(id !== undefined && p) {
          var t = p[id];
          return t.first_name + " " + t.last_name + " - " + t.topic;
        }
        return "Error.";
      },
      _inputChanged: function(firstname, lastname, grade, house) {
        this.$.submit.disabled = firstname.length == 0 || lastname.length == 0 || grade == '-1' || house == '-1';
        this.$.reset.disabled = firstname.length == 0 && lastname.length == 0 && grade == '-1' && house == '-1';

        if(firstname.length != 0 && this._toTitleCase(firstname) != firstname)
          this.firstname = this._toTitleCase(firstname);

        if(lastname.length != 0 && this._toTitleCase(lastname) != lastname)
          this.lastname = this._toTitleCase(lastname);
      },
      _computeDataReady: function(presentations, houses, grades) {
        return presentations && houses && grades;
      },
      _reset: function() {
        this.firstname = '';
        this.lastname = '';
        this.grade = '-1';
        this.house = '-1';
      },
      _toTitleCase: function(str) {
        return str.replace(/\w\S*/g, function(txt){return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();});
      },
      _confirm: function() {
        this.fire('dialog-signup-confirm-open',
          {
            callbacks: {
              requestCallback: this._request.bind(this),
              responseCallback: this._response.bind(this),
              errorCallback: this._error.bind(this),
            },
            data: {
              firstname: this.firstname,
              lastname: this.lastname,
              grade: this.grade,
              house: this.house,
              reserved: this.senior
            }
          });
      },
      _submit: function() {
        this._disableConfirm();
        this.$.signupAjax.body = JSON.stringify({
          'first_name': this.firstname,
          'last_name': this.lastname,
          'grade': this.grade,
          'house': this.house
        });
        this._ajaxRequest = this.$.signupAjax.generateRequest();
      },
      _log: function(e) {
        console.log(e);
      },
      _request: function(e) {
        console.log(e);
      },
      _disableConfirm: function() {
        this.$.confirmButton.disabled = true;
        this.$.confirmText.hidden = true;
        this.$.spinner.hidden = false;
      },
      _enableConfirm: function() {
        this.$.confirmButton.disabled = false;
        this.$.confirmText.hidden = false;
        this.$.spinner.hidden = true;
        this._ajaxRequest = null;
      },
      _response: function(e) {
        console.log(e);

        if(e.detail.response) {
          if(e.detail.response.status) {
            this.fire('dialog-signup-confirm-close');
            //load presentation data & go to preferences page
            this.fire('do-signup', e.detail.response);
          } else {
            if(e.detail.response.details) {
              this.fire('firetoast', { message: "An error occurred. " + e.detail.response.details });
            } else {
              this.fire('firetoast', { message: "An error occurred." });
            }
          }
        }
        
      },
      _error: function(e) {
        console.log(e);

        if(e.detail.error.message) {
          if(e.detail.error.message.indexOf("418")) {
            this.fire('firetoast', { message: "Signups are closed!" });
          } else {
            this.fire('firetoast', { message: "An error occurred. " + e.detail.error.message });
          }
        } else {
          this.fire('firetoast', { message: "An error occurred." });
        }
      },
      ready: function() {
        
      },
      reset: function() {
        this.firstname = '';
        this.lastname = '';
        this.house = '-1';
        this.grade = '-1';
      },
      _reserveCancel: function(e) {
        console.log("yOYOYOYOY");
        console.log(this.grade);
        this.grade = '-1';
      },
      _reserveConfirm: function(e) {
        this.senior = e;
      },
      _grade: function(e) {
        console.log(e);
        if(e == 4) {
          this.senior = undefined;
          this.fire('dialog-reservedspot-open', {
            callbacks: {
              requestCallback: this._request.bind(this),
              responseCallback: this._response.bind(this),
              errorCallback: this._error.bind(this),
              confirmCallback: this._reserveConfirm.bind(this),
              cancelCallback: this._reserveCancel.bind(this)
            }
          });
        }
      },
      _isSenior: function(e) {
        return e == 4;
      }
    });
  </script>
</dom-module>
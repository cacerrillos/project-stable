<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../bower_components/polymer-sortablejs/polymer-sortablejs.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-fab/paper-fab.html">

<link rel="import" href="presentation-row.html">
<!--
A comment describing this element

Example:

    <my-elem></my-elem>

Example:

    <my-elem>
      <h2>Hello my-elem</h2>
    </my-elem>

@demo demo/index.html
-->

<dom-module id="signup-page">
  <template>
    <style include="iron-flex iron-flex-alignment">
      :host {
        display: block;
        padding-bottom: 48px;
      }
      paper-material {
        padding: 8px;
        margin-bottom: 32px;
        background-color: white;
      }
      h1, h2, h3, h4, h5, h6 {
        margin: 0;
      }
      presentation-row:hover {
        background-color: #e6e6e6;
      }
      #content {
        margin-left: auto;
        max-width: 960px;
        margin-right: auto;
      }
      paper-dialog {
        padding: 16px;
        max-width: 400px;
        background-color: white;
      }
      .center {
        margin-left: auto;
        margin-right: auto;
      }
      .close-btn {
        position: absolute;
        right: 0;
        top: 0;
        margin: 0;
        padding: 0;
      }
      paper-fab {
        position: fixed;
        bottom: 24px;
        right: 24px;
        z-index: 10000;
        background-color: var(--paper-green-500);
      }
      paper-button[disabled] {
        background-color: var(--paper-grey-500);
        color: white;
      }
      .start {
        background-color: var(--paper-blue-500);
        color: white;
      }
      .reset {
        background-color: var(--paper-red-500);
        color: white;
      }
    </style>
    <iron-ajax
      id="signupAjax"
      url="https://4n5e3ppiq7.execute-api.us-east-2.amazonaws.com/v1/signup/finish"
      method="POST"
      content-type="application/json"
      handle-as="json"
      on-request="_request"
      on-response="_response"
      on-error="_error"></iron-ajax>

    <paper-dialog id="infoDialog" modal>
      <paper-icon-button icon="icons:close" dialog-dismiss class="close-btn"></paper-icon-button>
      <div class="layout vertical" style="margin: 0;">
        <h2 class="center">[[infoData.topic]]</h2>
        <div>Presenter: <b>[[infoData.first_name]] [[infoData.last_name]]</b></div>
        <div>Location: <b>Location</b></div>
        <div>Bio:<br>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Curabitur et augue vitae urna elementum tristique. Aliquam finibus semper ligula, molestie hendrerit leo dictum id. Duis nisi quam, eleifend in arcu at, fermentum cursus massa. Phasellus blandit ligula eu odio scelerisque aliquam. Vivamus porta at mi ornare lobortis. Nam ante eros.</div>
      </div>
    </paper-dialog>
    <paper-dialog id="confirmDialog" style="padding: 0;">
      <div class="layout vertical">
        <h2>Confirmation</h2>
        <p>Are you sure you're ready to submit?</p>
        <div class="layout horizontal" style="margin-top: 16px;">
          <div class="flex"></div>
          <paper-button id="confirmButton" raised class="start" on-tap="_submit">
            <paper-spinner id="spinner" active hidden></paper-spinner>
            <div id="confirmText">Confirm</div>
          </paper-button>
          <paper-button id="cancelButton" raised on-tap="_cancel" class="reset">Cancel</paper-button>
        </div>
      </div>
    </paper-dialog>

    <div id="content">
      <template is="dom-repeat" items="[[dates]]" as="date">
        <template is="dom-repeat" items="[[blocksArr]]" as="block">
          <paper-material elevation="1">
            <h3>[[_parseDate(date.date)]] - [[block.block_name]] Block</h3>
            <sortable-js
            class$="[[_computeSorter(date.date, block.block_id)]]"
            draggable="presentation-row"
            handle=".handle"
            filter=".no-drag"
            data-id-attr="data-id"
            on-update="_sortableUpdate">
              <template is="dom-repeat" items="[[_filterPresentations(date.date, block.block_id, presentations)]]" as="presentation">
                <presentation-row
                  data="[[presentation]]"
                  order="[[block.order]]"
                  data-id$="[[presentation.presentation_id]]"
                  on-move-up="_doMoveUp"
                  on-move-down="_doMoveDown"
                  on-show-info="_showInfo"
                  ></presentation-row>
              </template>
            </sortable-js>
            
          </paper-material>
        </template>
      </template>
    </div>

    <paper-toast id="errorToast" text="An error occurred."></paper-toast>
    <paper-fab icon="save" on-tap="_confirm"></paper-fab>
  </template>
  <script>
    Polymer({
      is: 'signup-page',
      properties: {
        dates: {
          type: Array
        },
        blocks: {
          type: Object
        },
        blocksArr: {
          type: Array,
          computed: '_computeBlocksArr(blocks)'
        },
        presentations: {
          type: Object
        },
        infoData: {
          type: Object,
          value: {}
        },
        toSave: {
          type: Object,
          value: {}
        },
        userData: {
          type: Object
        }
      },
      reset: function() {
        this.toSave = {};
        this.blocksArr = this._computeBlocksArr(this.blocks);
      },
      _objToArray: function(obj) {
        if(obj)
          return Object.keys(obj).map(function (key) { return obj[key]; });
      },
      _parseDate: function(e) {
        var str = e.toString();
        console.log(str);

        if(!/^(\d){8}$/.test(str))
          return "Invalid date!";

        var y = str.substr(0,4),
            m = str.substr(4,2),
            d = str.substr(6,2);
            console.log(y + " " + m + " " + d);
        return new Date(y,parseInt(m) - 1,d).toDateString();
      },
      _computeBlocksArr: function(blocks) {
        return this._objToArray(blocks);
      },
      _getPresentations: function(dateblock, presentations) {
        return presentations[dateblock.guid];
      },
      _filterPresentations: function(date, block, presentations) {
        var result = [];

        for(var k in presentations) {
          if(!presentations.hasOwnProperty(k)) continue;
          
          var thisPresentation = presentations[k];

          if(thisPresentation.date === date && thisPresentation.block_id === block)
            result.push(thisPresentation);
        }

        return result;
      },
      _sortableUpdate: function(e) {
        var order = e.target.sortable.toArray();
        //TODO: save the order
        e.model.set('block.order', order);
        //

        var date = e.model.get('date.date');
        var block_id = e.model.get('block.block_id');

        if(!this.toSave[date]) {
          this.toSave[date] = {};
        }
        // if(!this.toSave[date][block_id])
        this.toSave[date][block_id] = order;
        for(var x = 0; x < this.toSave[date][block_id].length; x++) {
          this.toSave[date][block_id][x] = parseInt(this.toSave[date][block_id][x]);
        }

      },
      _sortableAdd: function(e) {
        console.log(e);
      },
      _doMoveUp: function(e) {
        console.log("Move " + e.detail.presentation_id + " up in " + this._computeSorter(e.detail.date, e.detail.block));
      },
      _doMoveDown: function(e) {
        console.log(e);
        var s = this._computeSorter(e.detail.date, e.detail.block);
        console.log("Move " + e.detail.presentation_id + " down in " + this._computeSorter(e.detail.date, e.detail.block));
        console.log(Polymer.dom(this.$.content).getEffectiveChildren());//("." + s));
      },
      _computeSorter: function(date, block) {
        return (date + "-" + block).replace(/\s/g, "-");
      },
      _showInfo: function(e) {
        this.infoData = this.presentations[e.detail.presentation_id];
        this.$.infoDialog.open();
      },
      _confirm: function(e) {
        this._enableConfirm();
        this.$.confirmDialog.open();
      },
      _save: function(e) {
        //open confirm dialog
        //this.$.confirmationDialog.open();
        //this.fire('signup-done');
      },
      _disableConfirm: function() {
        this.$.confirmButton.disabled = true;
        this.$.confirmText.hidden = true;
        this.$.spinner.hidden = false;
      },
      _enableConfirm: function() {
        this.$.confirmButton.disabled = false;
        this.$.confirmText.hidden = false;
        this.$.spinner.hidden = true;
        this._ajaxRequest = null;
      },
      _cancel: function() {
        if(this._ajaxRequest != null)
          this._ajaxRequest.abort();
        else
          this.$.confirmDialog.close();
      },
      _submit: function() {
        this._disableConfirm();
        this.$.signupAjax.body = JSON.stringify({
          'status': true,
          'viewer_id': parseInt(this.userData.viewer_id),
          'viewer_key': this.userData.viewer_key,
          'data': this.toSave
        });
        this._ajaxRequest = this.$.signupAjax.generateRequest();
      },
      _response: function(e) {
        console.log(e);
        if(e.detail.response) {
          if(e.detail.response.status) {
            
            //load presentation data & go to preferences page
            //this.fire('do-signup', e.detail.response);
            this.$.errorToast.text = "Saved!";
            this.$.errorToast.show();
            var thus = this;
            setTimeout(function(){
              thus.fire('signup-done');
              thus.$.confirmDialog.close();
            }, 3500);
            
          } else {
            if(e.detail.response.details) {
              this.$.errorToast.text = "An error occurred. " + e.detail.response.details;
            } else {
              this.$.errorToast.text = "An error occurred.";
            }
            this.$.errorToast.show();
            this._enableConfirm();
          }
        }
      },
      _error: function(e) {
        console.log(e);
        this._enableConfirm();

        if(e.detail.error.message) {
          this.$.errorToast.text = "An error occurred. " + e.detail.error.message;
        } else {
          this.$.errorToast.text = "An error occurred.";
        }
        this.$.errorToast.show();
      }
    });
  </script>
</dom-module>
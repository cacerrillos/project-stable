<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../bower_components/polymer-sortablejs/polymer-sortablejs.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../../bower_components/paper-checkbox/paper-checkbox.html">

<link rel="import" href="presentation-row.html">
<link rel="import" href="../stable-app/stable-behavior.html">
<!--
A comment describing this element

Example:

    <my-elem></my-elem>

Example:

    <my-elem>
      <h2>Hello my-elem</h2>
    </my-elem>

@demo demo/index.html
-->

<dom-module id="signup-page">
  <template>
    <style include="iron-flex iron-flex-alignment">
      :host {
        display: block;
        padding-bottom: 48px;
      }
      paper-material {
        padding: 8px;
        margin-bottom: 32px;
        background-color: white;
      }
      h1, h2, h3, h4, h5, h6 {
        margin: 0;
      }
      .highlight {
        padding: 0px;
      }
      .highlight:hover {
        background-color: #e6e6e6;
      }
      #content {
        margin-left: auto;
        max-width: 960px;
        margin-right: auto;
      }
      paper-dialog {
        padding: 16px;
        max-width: 400px;
        background-color: white;
      }
      .center {
        margin-left: auto;
        margin-right: auto;
      }
      .close-btn {
        position: absolute;
        right: 0;
        top: 0;
        margin: 0;
        padding: 0;
      }
      paper-fab {
        position: fixed;
        bottom: 24px;
        right: 24px;
        z-index: 10000;
        background-color: var(--paper-green-500);
      }
      paper-button[disabled] {
        background-color: var(--paper-grey-500);
        color: white;
      }
      .start {
        background-color: var(--paper-blue-500);
        color: white;
      }
      .reset {
        background-color: var(--paper-red-500);
        color: white;
      }
      paper-toast {
        z-index: 10001;
      }
      paper-checkbox.vcenter {
        padding-left: 8px;
        margin-top: auto;
        margin-bottom: auto;
      }
      paper-radio-group {
        width: 100%;
      }
    </style>
    <iron-ajax
      id="signupAjax"
      url="https://4n5e3ppiq7.execute-api.us-east-2.amazonaws.com/v1/signup/finish"
      method="POST"
      content-type="application/json"
      handle-as="json"
      on-response="_response"
      on-error="_error"></iron-ajax>

    <paper-dialog id="infoDialog">
      <paper-icon-button icon="icons:close" dialog-dismiss class="close-btn"></paper-icon-button>
      <div class="layout vertical" style="margin: 0;">
        <h2 class="center">[[infoData.topic]]</h2>
        <div>Presenter: <b>[[infoData.first_name]] [[infoData.last_name]]</b></div>
        <div>Location: <b>Location</b></div>
        <div>Bio:<br>[[infoData.bio]]</div>
      </div>
    </paper-dialog>
    <paper-dialog id="confirmDialog" style="padding: 0;">
      <div class="layout vertical">
        <h2>Confirmation</h2>
        <p>Are you sure you're ready to submit?</p>
        <div class="layout horizontal" style="margin-top: 16px;">
          <div class="flex"></div>
          <paper-button id="confirmButton" raised class="start" on-tap="_submit">
            <paper-spinner id="spinner" active hidden></paper-spinner>
            <div id="confirmText">Confirm</div>
          </paper-button>
          <paper-button id="cancelButton" raised on-tap="_cancel" class="reset">Cancel</paper-button>
        </div>
      </div>
    </paper-dialog>

    <div id="content">
    <template is="dom-if" if="[[!selectable]]">
      <!-- <template is="dom-repeat" items="[[dates]]" as="date"> -->
        <!-- <template is="dom-repeat" items="[[blocksArr]]" as="block"> -->
          <paper-material elevation="1">
            <!-- <h3>[[_parseDate(date.date)]] - [[block.block_name]] Block</h3> -->
            <h3>All Presentations</h3>
            <!-- class$="[[_computeSorter(date.date, block.block_id)]]" -->
            <sortable-js
            draggable="presentation-row"
            handle=".handle"
            filter=".no-drag"
            data-id-attr="data-id"
            on-update="_sortableUpdate">
              <!-- <template is="dom-repeat" items="[[_filterPresentations(date.date, block.block_id, presentations)]]" as="presentation"> -->
              <template is="dom-repeat" items="[[presentationsArray]]" as="presentation">

                <presentation-row
                  data="[[presentation]]"
                  order="[[order]]"
                  data-id$="[[presentation.presentation_id]]"
                  on-move-up="_doMoveUp"
                  on-move-down="_doMoveDown"
                  on-show-info="_showInfo"
                  sortable
                  ></presentation-row>
              </template>
            </sortable-js>
            
          </paper-material>
        <!-- </template> -->
      <!-- </template> -->
      </template>
      <template is="dom-if" if="[[selectable]]">
        <template is="dom-repeat" items="[[dates]]" as="date">
          <template is="dom-repeat" items="[[blocksArr]]" as="block">
            <paper-material elevation="1">
              <h3>[[_parseDate(date.date)]] - [[block.block_name]]</h3>
              <!-- <h3>All Presentations</h3> -->
              <!-- class$="[[_computeSorter(date.date, block.block_id)]]" -->
                <template is="dom-repeat" items="[[_filterPresentations(date.date, block.block_id, presentations)]]" as="presentation">
                <!-- <template is="dom-repeat" items="[[presentationsArray]]" as="presentation"> -->
                  <div class="layout horizontal highlight">
                  <paper-checkbox
                    name$="[[presentation.presentation_id]]"
                    data-date="[[date.date]]"
                    data-block="[[block.block_id]]"
                    data-presentation-id="[[presentation.presentation_id]]"
                    id="selector"
                    class="vcenter"
                    on-change="_change"
                    hidden$="[[!selectable]]"
                    disabled="[[_pending]]"
                    ></paper-checkbox>
                    <!-- presentation.full, presentation.is_registered -->
                  <presentation-row
                    class="flex"
                    data="[[presentation]]"
                    order="[[order]]"
                    data-id$="[[presentation.presentation_id]]"
                    on-move-up="_doMoveUp"
                    on-move-down="_doMoveDown"
                    on-show-info="_showInfo"
                    names
                    selectable
                    >
                    </presentation-row>
                  </div>
                </template>
              
            </paper-material>
          </template>
        </template>
      </template>
    </div>

    <paper-toast id="errorToast" text="An error occurred."></paper-toast>
    <paper-fab icon="save" on-tap="_confirm"></paper-fab>
  </template>
  <script>
    Polymer({
      is: 'signup-page',
      properties: {
        dates: {
          type: Array
        },
        blocks: {
          type: Object
        },
        blocksArr: {
          type: Array,
          computed: '_objToArray(blocks)'
        },
        presentations: {
          type: Object
        },
        presentationsArray: {
          type: Array,
          computed: '_objToArray(presentations)'
        },
        infoData: {
          type: Object,
          value: {}
        },
        toSave: {
          type: Object,
          value: {}
        },
        userData: {
          type: Object
        },
        order: {
          type: Array
        },
        registrations: {
          type: Object
        },
        /*
          {
            "user": [ 1, 2, 3, 4], //registered presentation_ids
            "all": {
              1: {}
            }
          }

        */
        registrationsInternal: {
          type: Object,
          value: {}
        },
        /*
          {
            "20170505": {
              "1": -1,
              "2": -1,
              "3": -1
            }
          }
        */
        selectable: {
          type: Boolean,
          value: false,
          reflectToAttribute: true
        },
        _pending: {
          type: Boolean,
          value: false
        }
      },
      behaviors: [ StableBehavior ],
      reset: function() {
        this.toSave = [];
        this.order = [];
      },
      _getPresentations: function(dateblock, presentations) {
        return presentations[dateblock.guid];
      },
      _filterPresentations: function(date, block, presentations) {
        var result = [];

        for(var k in presentations) {
          if(!presentations.hasOwnProperty(k)) continue;
          
          var thisPresentation = presentations[k];

          if(thisPresentation.date === date && thisPresentation.block_id === block)
            result.push(thisPresentation);
        }

        return result;
      },
      _sortableUpdate: function(e) {
        var order = e.target.sortable.toArray();
        //TODO: save the order
        //e.model.set('block.order', order);
        this.order = order;

        this.toSave = order;
        return;
        //

        var date = e.model.get('date.date');
        var block_id = e.model.get('block.block_id');

        if(!this.toSave[date]) {
          this.toSave[date] = {};
        }
        // if(!this.toSave[date][block_id])
        this.toSave[date][block_id] = order;
        for(var x = 0; x < this.toSave[date][block_id].length; x++) {
          this.toSave[date][block_id][x] = parseInt(this.toSave[date][block_id][x]);
        }

      },
      _sortableAdd: function(e) {
        console.log(e);
      },
      _doMoveUp: function(e) {
        console.log("Move " + e.detail.presentation_id + " up in " + this._computeSorter(e.detail.date, e.detail.block));
      },
      _doMoveDown: function(e) {
        console.log(e);
        var s = this._computeSorter(e.detail.date, e.detail.block);
        console.log("Move " + e.detail.presentation_id + " down in " + this._computeSorter(e.detail.date, e.detail.block));
        console.log(Polymer.dom(this.$.content).getEffectiveChildren());//("." + s));
      },
      _computeSorter: function(date, block) {
        return (date + "-" + block).replace(/\s/g, "-");
      },
      _showInfo: function(e) {
        this.infoData = this.presentations[e.detail.presentation_id];
        this.$.infoDialog.open();
      },
      _confirm: function(e) {
        this._enableConfirm();
        this.$.confirmDialog.open();
      },
      _save: function(e) {
        //open confirm dialog
        //this.$.confirmationDialog.open();
        //this.fire('signup-done');
      },
      _disableConfirm: function() {
        this.$.confirmButton.disabled = true;
        this.$.confirmText.hidden = true;
        this.$.spinner.hidden = false;
      },
      _enableConfirm: function() {
        this.$.confirmButton.disabled = false;
        this.$.confirmText.hidden = false;
        this.$.spinner.hidden = true;
        this._ajaxRequest = null;
      },
      _cancel: function() {
        if(this._ajaxRequest != null)
          this._ajaxRequest.abort();
        else
          this.$.confirmDialog.close();
      },
      _submit: function() {
        this._disableConfirm();
        this.$.signupAjax.body = JSON.stringify({
          'status': true,
          'viewer_id': parseInt(this.userData.viewer_id),
          'viewer_key': this.userData.viewer_key,
          'data': this.toSave
        });
        this._ajaxRequest = this.$.signupAjax.generateRequest();
      },
      _response: function(e) {
        console.log(e);
        if(e.detail.response) {
          if(e.detail.response.status) {
            
            //load presentation data & go to preferences page
            //this.fire('do-signup', e.detail.response);

            this.$.confirmDialog.close();
            this.fire('signup-done', { error: false });
            
          } else {
            if(e.detail.response.code !== undefined) {
              this.fire('signup-done', { error: true });
              this.$.confirmDialog.close();
            } else {
              if(e.detail.response.details) {
                this.$.errorToast.text = "An error occurred. " + e.detail.response.details;
              } else {
                this.$.errorToast.text = "An error occurred.";
              }
              this.$.errorToast.show();
            }
            
            this._enableConfirm();
          }
        }
      },
      _error: function(e) {
        console.log(e);
        this._enableConfirm();

        if(e.detail.error.message) {
          if(e.detail.error.message.indexOf("418") !== -1) {
            this.fire('signup-done', { closed: true });
            this.$.confirmDialog.close();
            return;
          }
          this.$.errorToast.text = "An error occurred. " + e.detail.error.message;
        } else {
          this.$.errorToast.text = "An error occurred.";
        }
        this.$.errorToast.show();
      },
      _change: function(e) {
        var date = e.model.get('date.date');
        var block_id = e.model.get('block.block_id');
        var presentation_id = e.model.get('presentation.presentation_id');
        if(this.registrationsInternal) {
          if(!this.registrationsInternal[date]) {
            this.registrationsInternal[date] = {};
          }
          if(!this.registrationsInternal[date][block_id]) {
            this.registrationsInternal[date][block_id] = -1;
          }

          if(this.registrationsInternal[date][block_id] == -1) {
            this.registrationsInternal[date][block_id] = presentation_id;
          } else {
            if(e.target.checked) {
              this._des(date, block_id, this.registrationsInternal[date][block_id]);
              console.log("warn, already registered in this slot");
              this.registrationsInternal[date][block_id] = presentation_id;
            } else {
              this.registrationsInternal[date][block_id] = -1;
            }
            
          }
        }


        if(e.target.checked) {
          this._doRegisterReq(e.model.get('presentation.presentation_id'));
        }
        this._disableCheckboxes();
      },
      _des: function(date, block_id, presentation_id) {
        var ch = Polymer.dom(this.$.content).querySelectorAll("paper-checkbox");
        for(var k in ch) {
          if(!ch.hasOwnProperty(k)) continue;

          var cb = ch[k];
          if(cb.dataDate == date && cb.dataBlock == block_id && cb.dataPresentationId == presentation_id) {
            cb.checked = false;
          }
        }
      },
      _disableCheckboxes: function() {
        this._pending = true;
        setTimeout(function(){ this._pending = false; }.bind(this), 3000);
      },
      _doRegisterReq: function(presentation_id) {
        // this.$.ajax.body = JSON.stringify({ presentation_id: p_id, viewer_id:  this.regStatus.viewer_id });
        // this.$.ajax.generateRequest();
        /*
        this.fire('firetoast', { message: "Already Registered!"});
        this.$.regAjax.generateRequest();
        */
      },
      _or: function(a, b) {
        return a || b;
      }
    });
  </script>
</dom-module>
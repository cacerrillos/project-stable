<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../bower_components/paper-drawer-panel/paper-drawer-panel.html">
<link rel="import" href="../../bower_components/paper-header-panel/paper-header-panel.html">
<link rel="import" href="../../bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../../bower_components/app-route/app-route.html">
<link rel="import" href="../../bower_components/app-route/app-location.html">
<link rel="import" href="../../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../../bower_components/app-storage/app-localstorage/app-localstorage-document.html">

<link rel="import" href="../signup-page/registration-page.html">
<link rel="import" href="../schedule-page/schedule-page.html">
<link rel="import" href="../viewers-page/viewers-page.html">
<link rel="import" href="../presentations-page/presentations-page.html">
<!-- <link rel="import" href="../edit-item-pages/edit-locations-page.html"> -->
<link rel="import" href="stable-behavior.html">

<dom-module id="stable-app">
  <template>
    <style include="iron-flex iron-flex-alignment">
      :host {
        display: block;
      }
      .container {
        margin: 10px;
      }
      .content {
        padding: 16px;
        padding-left: 4px;
        padding-right: 4px;
        max-width: 720px;
        margin-left: auto;
        margin-right: auto;
      }
      .side-bar-content {
        margin-bottom: 16px;
      }
      .center {
        margin-left: auto;
        margin-right: auto;
      }
      .shameless {
        position: absolute;
        bottom: 8px;
        width: 100%;
      }
    </style>
    <app-localstorage-document id="adminCodeStorage" key="admincode" data="{{adminCode}}">

    <app-location route="{{route}}" use-hash-as-path></app-location>
    <app-route route="{{route}}" pattern="/:page" data="{{routeData}}" tail="{{tail}}"></app-route>

    <iron-ajax
      auto
      id="blocksAjax"
      url="[[_computeAPI('/blocks')]]"
      handle-as="json"
      content-type="application/json"
      on-error="_onError"
      on-response="ajaxResponse"
      last-response="{{blocks}}"></iron-ajax>
    <iron-ajax
      auto
      id="datesAjax"
      url="[[_computeAPI('/dates')]]"
      handle-as="json"
      content-type="application/json"
      on-error="_onError"
      on-response="ajaxResponse"
      last-response="{{dates}}"></iron-ajax>
    <iron-ajax
      auto
      id="housesAjax"
      url="[[_computeAPI('/houses')]]"
      handle-as="json"
      content-type="application/json"
      on-error="_onError"
      on-response="ajaxResponse"
      last-response="{{houses}}"></iron-ajax>
    <iron-ajax
      auto
      id="gradesAjax"
      url="[[_computeAPI('/grades')]]"
      handle-as="json"
      content-type="application/json"
      on-error="_onError"
      on-response="ajaxResponse"
      last-response="{{grades}}"></iron-ajax>
    <iron-ajax
      id="locationsAjax"
      url="[[_computeAPI('/locations')]]"
      handle-as="json"
      content-type="application/json"
      on-error="_onError"
      on-response="ajaxResponse"
      last-response="{{locations}}"></iron-ajax>
    <iron-ajax
      id="presentationsAjax"
      url="[[_computeAPI('/presentations')]]"
      handle-as="json"
      content-type="application/json"
      on-error="_onError"
      on-response="ajaxResponse"
      last-response="{{presentations}}"></iron-ajax>
    <iron-ajax
      id="viewersAjax"
      url="[[_computeAPI('/viewers')]]"
      handle-as="json"
      content-type="application/json"
      on-error="_onError"
      on-response="ajaxResponse"
      last-response="{{viewers}}"></iron-ajax>
    <iron-ajax
      id="scheduleAjax"
      url="[[_computeAPI('/schedule')]]"
      handle-as="json"
      content-type="application/json"
      on-error="_onError"
      on-response="ajaxResponse"
      last-response="{{schedule}}"></iron-ajax>

    <paper-drawer-panel force-narrow id="paperDrawerPanel">
      <paper-header-panel drawer>
        <paper-toolbar>
          <div>iPoly Career Day</div>
        </paper-toolbar>
        <div class="layout vertical side-bar-content">
          <paper-menu attr-for-selected="name" selected="{{routeData.page}}" on-tap="_closeDrawer">
            <paper-item name="registration">Registration</paper-item>
            <paper-item name="presentations" class="layout horizontal">Presentations<div class="flex"></div><iron-icon icon="icons:print"></iron-icon></paper-item>
            <paper-item name="schedule">Schedule</paper-item>
            <paper-item name="viewers">Viewers</paper-item>
            <!-- <paper-item name="locations">Locations</paper-item> -->
          </paper-menu>          
        </div>
        <div class="shameless layout horizontal">
        <div class="flex"></div>
          <a href="https://github.com/cacerrillos/project-stable" target="_blank">
            <paper-icon-button src="github.png"></paper-icon-button>
          </a>
          <div class="flex"></div>
        </div>
      </paper-header-panel>
      <paper-header-panel main>
        <paper-toolbar>
          <paper-icon-button id="backButton" icon="icons:arrow-back" on-tap="_goBack" hidden></paper-icon-button>
          <paper-icon-button id="menuButton" icon="icons:menu" paper-drawer-toggle></paper-icon-button>
          <div>iPoly Career Day [[titleText]]</div>
        </paper-toolbar>
        <div class="container">
          <div class="content">
            <iron-pages attr-for-selected="name" selected="[[routeData.page]]">
              <registration-page
                route="{{route}}"
                name="registration"
                dates="[[dates]]"
                grades="[[grades]]"
                houses="[[houses]]"
                blocks="[[blocks]]"
                presentations="[[presentations]]"
                ></registration-page>
              <schedule-page
                route="{{route}}"
                name="schedule"
                dates="[[dates]]"
                grades="[[grades]]"
                houses="[[houses]]"
                blocks="[[blocks]]"
                presentations="[[presentations]]"
                locations="[[locations]]"
                schedule="[[schedule]]"
                admin-code="{{adminCode}}"
                ></schedule-page>
              <viewers-page
                route="{{route}}"
                houses="[[houses]]"
                grades="[[grades]]"
                viewers="[[viewers]]"
                dates="[[dates]]"
                blocks="[[blocks]]"
                presentations="[[presentations]]"
                locations="[[locations]]"
                name="viewers"
                ></viewers-page>
              <presentations-page
                name="presentations"
                route="{{route}}"
                presentations="[[presentations]]"
                ></presentations-page>
              <!-- <edit-locations-page
                route="{{route}}"
                name="locations"
                locations="[[locations]]"
                admin-code="{{adminCode}}"
                ></edit-locations-page> -->
            </iron-pages>
            
          </div>
        </div>
      </paper-header-panel>
    </paper-drawer-panel>
    <paper-toast id="globalToast"></paper-toast>
  </template>
  <script>
    Polymer({

      is: 'stable-app',

      properties: {
        titleText: {
          type: String,
          value: ''
        },
        page: {
          type: String,
          value: 'registration',
          observer: '_onPageChanged'
        },
        routeData: {
          type: Object
        },
        adminCode: {
          type: String,
          value: ''
        },
        tail: {
          type: Object
        }
      },
      observers: [
      ],
      behaviors: [ StableBehavior ],
      listeners: {
        'set-title': '_handleSetTitle',
        'goto-page': '_handleGotoPage',
        'firetoast': '_handleToast',
        'reload-blocks': '_reloadBlocks',
        'reload-dates': '_reloadDates',
        'reload-houses': '_reloadHouses',
        'reload-grades': '_reloadGrades',
        'reload-locations': '_reloadLocations',
        'reload-presentations': '_reloadPresentations',
        'reload-viewers': '_reloadViewers',
        'reload-schedule': '_reloadSchedule',
        'show-back-button': '_handleShowBackButton'
      },
      ready: function(e) {
        console.log("path: " + this.routeData.page);
        console.log(this.routeData);
        if(this.routeData) {
          if(this.routeData.page == undefined || this.routeData.page == '') {
            //this.set('route.path', '/registration');
            window.location.href = '#/registration';
          }
        }
      },
      _handleSetTitle: function(e) {
        if(e && e.detail && e.detail.title) {
          this.titleText = e.detail.title;          
        } else {
          this.titleText = '';
        }
      },
      _handleGotoPage: function(e) {
        console.log(e);
        if(e && e.detail && e.detail.page) {
          this.page = e.detail.page;
        }
        console.log(this.page);
      },
      _onPageChanged: function(e) {
        console.log('changed: ' + e);
        this.set('route.path', '/' + e);
      },
      _closeDrawer: function(e) {
        this.$.paperDrawerPanel.closeDrawer();
      },
      _handleToast: function(e) {
        if(e && e.detail) {
          this.$.globalToast.text = e.detail.message;
          this.$.globalToast.show();
        }
      },
      _reloadBlocks: function(e) {
        this.$.blocksAjax.generateRequest();
      },
      _reloadGrades: function(e) {
        this.$.gradesAjax.generateRequest();
      },
      _reloadHouses: function(e) {
        this.$.housesAjax.generateRequest();
      },
      _reloadDates: function(e) {
        this.$.datesAjax.generateRequest();
      },
      _reloadLocations: function(e) {
        this.$.locationsAjax.generateRequest();
      },
      _reloadPresentations: function(e) {
        this.$.presentationsAjax.generateRequest();
      },
      _reloadViewers: function(e) {
        this.$.viewersAjax.generateRequest();
      },
      _reloadSchedule: function(e) {
        this.$.scheduleAjax.generateRequest();
      },
      _handleShowBackButton: function(e) {
        var temp = true;
        if(e.detail !== undefined)
          temp = e.detail;

        this.$.backButton.hidden = !temp;
        this.$.menuButton.hidden = temp;
      },
      _goBack: function(e) {
        this.$.backButton.hidden = true;
        this.$.menuButton.hidden = false;
        window.history.back();
      },
      _onError: function(e) {
        this._handleToast({ detail: {
          message: 'Failed to fetch data! Please reload!'
        }});
      }
    });
  </script>
</dom-module>

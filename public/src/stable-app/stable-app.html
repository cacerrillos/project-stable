<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../bower_components/paper-drawer-panel/paper-drawer-panel.html">
<link rel="import" href="../../bower_components/paper-header-panel/paper-header-panel.html">
<link rel="import" href="../../bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../../bower_components/app-route/app-route.html">
<link rel="import" href="../../bower_components/app-route/app-location.html">
<link rel="import" href="../../bower_components/paper-toast/paper-toast.html">

<link rel="import" href="../signup-page/registration-page.html">
<link rel="import" href="../presentations-page/presentations-page.html">
<link rel="import" href="../viewers-page/viewers-page.html">

<dom-module id="stable-app">
  <template>
    <style include="iron-flex iron-flex-alignment">
      :host {
        display: block;
      }
      .container {
        margin: 10px;
      }
      .content {
        padding: 16px;
        max-width: 720px;
        margin-left: auto;
        margin-right: auto;
      }
      .side-bar-content {
        margin-bottom: 16px;
      }
      .center {
        margin-left: auto;
        margin-right: auto;
      }
    </style>
    <app-location route="{{route}}" use-hash-as-path></app-location>
    <app-route route="{{route}}" pattern="/:page" data="{{routeData}}" tail="{{tail}}"></app-route>

    <iron-ajax
      auto
      id="blocksAjax"
      url="[[_computeAPI('/blocks')]]"
      handle-as="json"
      content-type="application/json"
      on-error="_onError"
      on-response="ajaxResponse"
      last-response="{{blocks}}"></iron-ajax>
    <iron-ajax
      auto
      id="datesAjax"
      url="[[_computeAPI('/dates')]]"
      handle-as="json"
      content-type="application/json"
      on-error="_onError"
      on-response="ajaxResponse"
      last-response="{{dates}}"></iron-ajax>
    <iron-ajax
      auto
      id="housesAjax"
      url="[[_computeAPI('/houses')]]"
      handle-as="json"
      content-type="application/json"
      on-error="_onError"
      on-response="ajaxResponse"
      last-response="{{houses}}"></iron-ajax>
    <iron-ajax
      auto
      id="gradesAjax"
      url="[[_computeAPI('/grades')]]"
      handle-as="json"
      content-type="application/json"
      on-error="_onError"
      on-response="ajaxResponse"
      last-response="{{grades}}"></iron-ajax>
    <iron-ajax
      id="locationsAjax"
      url="[[_computeAPI('/locations')]]"
      handle-as="json"
      content-type="application/json"
      on-error="_onError"
      on-response="ajaxResponse"
      last-response="{{locations}}"></iron-ajax>
    <iron-ajax
      id="presentationsAjax"
      url="[[_computeAPI('/presentations')]]"
      handle-as="json"
      content-type="application/json"
      on-error="_onError"
      on-response="ajaxResponse"
      last-response="{{presentations}}"></iron-ajax>

    <paper-drawer-panel force-narrow id="paperDrawerPanel">
      <paper-header-panel drawer>
        <paper-toolbar>
          <div>Project Stable</div>
        </paper-toolbar>
        <div class="layout vertical side-bar-content">
          <paper-menu attr-for-selected="name" selected="{{routeData.page}}" on-tap="_closeDrawer">
            <paper-item name="registration">Registration</paper-item>
            <paper-item name="presentations">Presentations</paper-item>
            <paper-item name="viewers">Viewers</paper-item>
          </paper-menu>
          <div class="flex"></div>
          <a href="https://github.com/cacerrillos/project-stable" target="_blank" class="center">
            <paper-icon-button src="github.png"></paper-icon-button>
          </a>
        </div>
      </paper-header-panel>
      <paper-header-panel main>
        <paper-toolbar>
          <paper-icon-button icon="icons:menu" paper-drawer-toggle></paper-icon-button>
          <div>Project Stable [[titleText]]</div>
        </paper-toolbar>
        <div class="container">
          <div class="content">
            <iron-pages attr-for-selected="name" selected="[[routeData.page]]">
              <registration-page
                route="[[route]]"
                name="registration"
                dates="[[dates]]"
                grades="[[grades]]"
                houses="[[houses]]"
                blocks="[[blocks]]"
                presentations="[[presentations]]"
                ></registration-page>
              <presentations-page route="[[route]]" name="presentations" admin-code="{{adminCode}}"></presentations-page>
              <viewers-page route="[[route]]" name="viewers"></viewers-page>
            </iron-pages>
            
          </div>
        </div>
      </paper-header-panel>
    </paper-drawer-panel>
    <paper-toast id="globalToast"></paper-toast>
  </template>
  <script>
    Polymer({

      is: 'stable-app',

      properties: {
        titleText: {
          type: String,
          value: ''
        },
        page: {
          type: String,
          value: 'registration',
          observer: '_onPageChanged'
        },
        routeData: {
          type: Object
        },
        adminCode: {
          type: String,
          value: ''
        }
      },
      observers: [
      ],
      behaviors: [ StableBehavior ],
      listeners: {
        'set-title': '_handleSetTitle',
        'goto-page': '_handleGotoPage',
        'firetoast': '_handleToast',
        'reload-blocks': '_reloadBlocks',
        'reload-dates': '_reloadDates',
        'reload-houses': '_reloadHouses',
        'reload-grades': '_reloadGrades',
        'reload-locations': '_reloadLocations',
        'reload-presentations': '_reloadPresentations'
      },
      ready: function(e) {
        console.log("path: " + this.routeData.page);
        console.log(this.routeData);
        if(this.routeData) {
          if(this.routeData.page == undefined || this.routeData.page == '') {
            //this.set('route.path', '/registration');
            window.location.href = '#/registration';
          }
        }
      },
      _handleSetTitle: function(e) {
        if(e && e.detail && e.detail.title) {
          this.titleText = e.detail.title;          
        } else {
          this.titleText = '';
        }
      },
      _handleGotoPage: function(e) {
        console.log(e);
        if(e && e.detail && e.detail.page) {
          this.page = e.detail.page;
        }
        console.log(this.page);
      },
      _onPageChanged: function(e) {
        console.log('changed: ' + e);
        this.set('route.path', '/' + e);
      },
      _closeDrawer: function(e) {
        this.$.paperDrawerPanel.closeDrawer();
      },
      _handleToast: function(e) {
        if(e && e.detail) {
          this.$.globalToast.text = e.detail.message;
          this.$.globalToast.show();
        }
      },
      _reloadBlocks: function(e) {
        this.$.blocksAjax.generateRequest();
      },
      _reloadGrades: function(e) {
        this.$.gradesAjax.generateRequest();
      },
      _reloadHouses: function(e) {
        this.$.housesAjax.generateRequest();
      },
      _reloadDates: function(e) {
        this.$.datesAjax.generateRequest();
      },
      _reloadLocations: function(e) {
        this.$.locationsAjax.generateRequest();
      },
      _reloadPresentations: function(e) {
        this.$.presentationsAjax.generateRequest();
      }
    });
  </script>
</dom-module>
